<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MS Graph API Caller</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="notification-bar"></div>
  <div class="container">
    <div class="header-container">      <h5 class="header">
        <img src="extension_icon32.png" alt="Extension Icon">
        Intune Admin Center Tools
      </h5>
      <div class="header-controls">
        <div class="settings-menu">
          <button id="settingsButton" class="settings-btn" title="Settings">
            <i class="material-icons">more_vert</i>
          </button>
          <div id="settingsDropdown" class="settings-dropdown">
            <a href="#" id="showWelcomeOption">
              <i class="material-icons">help_outline</i>
              Show Welcome Guide
            </a>
            <a href="#" id="resetWelcomeOption">
              <i class="material-icons">refresh</i>
              Reset Welcome Status
            </a>
            <a href="#" id="clearStorageOption">
              <i class="material-icons">delete_sweep</i>
              Clear Extension Storage
            </a>
            <div class="settings-divider"></div>
            <div class="version-info">
              <i class="material-icons">info_outline</i>
              Version <span id="extensionVersion">1.5.0</span>
            </div>
          </div>
        </div>
        <div class="theme-switch-wrapper">
          <span class="theme-label">
            <i class="material-icons mode-icon light-icon">wb_sunny</i>
          </span>
          <div class="theme-switch-container">
            <button id="theme-toggle" class="theme-button">
              <span class="theme-icon"></span>
            </button>
          </div>
          <span class="theme-label">
            <i class="material-icons mode-icon dark-icon">nights_stay</i>
          </span>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      <div class="output-area">
        <!-- Search and Group Results -->
        <div class="input-field">
          <input type="text" id="groupSearchInput" placeholder="Enter group name">
        </div>
        <div class="button-row">
          <a id="searchGroup" class="waves-effect waves-light btn cyan lighten-1">Search Groups</a>
          <a id="createGroup" class="waves-effect waves-light btn cyan lighten-1">Create Group</a>        </div>
        <div id="groupResults"></div>        <!-- Configuration Table -->
        <div id="configTable">
          <h6>Configuration Assignments <span id="deviceNameDisplay"></span></h6>
          
          <!-- Dynamic Query Section (for dynamic groups) -->
          <div id="dynamicQuerySection" style="display: none;">
            <details>
              <summary style="cursor: pointer; padding: 8px 0; font-weight: 500; color: #1976d2;">
                <i class="material-icons" style="vertical-align: middle; font-size: 18px;">info_outline</i>
                Dynamic Membership Rule
              </summary>
              <div style="margin-top: 8px; padding: 12px; background-color: #f5f5f5; border-left: 3px solid #1976d2; border-radius: 4px; font-family: monospace; font-size: 12px; word-wrap: break-word; overflow-wrap: break-word;">
                <pre id="dynamicQueryContent" style="margin: 0; white-space: pre-wrap; word-wrap: break-word;"></pre>
              </div>
            </details>
          </div>
          
          <div class="input-field profile-filter-container">
            <input type="text" id="profileFilterInput" placeholder="Filter by name...">
          </div>
          <table class="striped">
            <thead>
              <tr>
                <th class="sortable">Profile Name</th>
                <th>Group Name</th>
                <th>Membership Type</th>
                <th>Target Type</th>
              </tr>
            </thead>
            <tbody id="configTableBody">
              <!-- Dynamic content -->
            </tbody>
          </table>
          
          <!-- Pagination Controls -->
          <div id="paginationContainer" class="pagination-container" style="display: none;">
            <div class="pagination-info">
              <span id="paginationResults">Showing 1â€“10 of 0 results</span>
            </div>
            <div class="pagination-controls">
              <button id="prevPageBtn" class="pagination-btn" disabled>
                <i class="material-icons">chevron_left</i>
              </button>
              <div id="pageNumbers" class="page-numbers">
                <!-- Dynamic page numbers -->
              </div>
              <button id="nextPageBtn" class="pagination-btn" disabled>
                <i class="material-icons">chevron_right</i>
              </button>
              <button id="exportCsvBtn" class="export-csv-btn" title="Export to CSV">
                <i class="material-icons">download</i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="controls-area">

        <div class="control-card">
          <div class="card-header">Target Mode</div>
          <div class="target-type-toggle">
            <button id="deviceModeBtn" class="active" data-mode="device">
              <i class="material-icons">devices</i> Device
            </button>
            <button id="userModeBtn" data-mode="user">
              <i class="material-icons">person</i> User
            </button>
          </div>
        </div>

        <div class="actions-scroller">

          <div class="control-group">
            <h6 class="group-title">Membership</h6>
            <div class="action-grid">
              <a id="addToGroups" class="btn-modern" role="button">
                <i class="material-icons">group_add</i>
                <span id="addBtnText">Add</span>
              </a>
              <a id="removeFromGroups" class="btn-modern" role="button">
                <i class="material-icons">group_remove</i>
                <span id="removeBtnText">Remove</span>
              </a>
              <a id="bulkAddMembers" class="btn-modern" role="button">
                <i class="material-icons">playlist_add</i>
                <span>Bulk Add</span>
              </a>
              <a id="clearGroupMembers" class="btn-modern" role="button">
                <i class="material-icons">playlist_remove</i>
                <span>Bulk Remove</span>
              </a>
              <a id="createDeviceGroupFromUsers" class="btn-modern full-width" role="button">
                <i class="material-icons">devices_other</i>
                <span>Create device group from users</span>
              </a>
              <a id="checkGroupMembers" class="btn-modern full-width" role="button">
                <i class="material-icons">people_outline</i>
                <span>Check Members</span>
              </a>
            </div>
          </div>

          <div class="control-group">
            <h6 class="group-title">Assignments</h6>
            <div class="action-grid">
              <a id="checkGroups" class="btn-modern" role="button">
                <i class="material-icons">settings</i>
                <span>Config</span>
              </a>
              <a id="checkCompliance" class="btn-modern" role="button">
                <i class="material-icons">verified_user</i>
                <span>Compliance</span>
              </a>
              <a id="appsAssignment" class="btn-modern" role="button">
                <i class="material-icons">apps</i>
                <span>Apps</span>
              </a>
              <a id="checkGroupAssignments" class="btn-modern" role="button">
                <i class="material-icons">assignment_ind</i>
                <span>Group</span>
              </a>
              <a id="pwshProfiles" class="btn-modern full-width" role="button">
                <i class="material-icons">terminal</i>
                <span>PowerShell</span>
              </a>
            </div>
          </div>

          <div class="control-group">
            <h6 class="group-title">Tools & Diagnostics</h6>
            <div class="action-grid">
              <a id="downloadScript" class="btn-modern full-width" role="button">
                <i class="material-icons">download</i>
                <span>PowerShell Script</span>
              </a>
              <a id="collectLogs" class="btn-modern full-width warning-action" role="button">
                <i class="material-icons">bug_report</i>
                <span>Collect Logs</span>
              </a>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Remove Modal Dialog -->
  <div id="clearMembersModal" class="modal-overlay" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-header">
        <h6>Bulk Remove Group Members</h6>
        <button class="modal-close" id="clearMembersModalClose">
          <i class="material-icons">close</i>
        </button>
      </div>
      <div class="modal-body">
        <p id="clearMembersGroupName" class="modal-group-name"></p>
        <p class="modal-description">Choose which members to remove:</p>
        
        <div class="clear-action-buttons">
          <button id="clearSelectedMembersBtn" class="action-choice-btn" disabled>
            <i class="material-icons">playlist_remove</i>
            <span class="action-btn-text">
              <strong>Remove selected</strong>
              <span id="selectedMembersCount" class="action-count">No rows selected</span>
            </span>
          </button>
          
          <button id="clearAllMembersBtn" class="action-choice-btn">
            <i class="material-icons">delete_sweep</i>
            <span class="action-btn-text">
              <strong>Remove all members</strong>
              <span id="allMembersCount" class="action-count">Loading...</span>
            </span>
          </button>
        </div>

        <!-- Confirmation section (shown after action selection) -->
        <div id="confirmationSection" style="display: none;">
          <div class="confirmation-divider"></div>
          
          <p class="confirmation-title">
            <i class="material-icons warning-icon">warning</i>
            Confirm removal
          </p>
          
          <p id="confirmationMessage" class="confirmation-message"></p>
          
          <!-- Scope selection checkboxes -->
          <div class="scope-selection">
            <label class="scope-label">
              <input type="checkbox" id="scopeUsers" checked>
              <span>Users</span>
            </label>
            <label class="scope-label">
              <input type="checkbox" id="scopeDevices" checked>
              <span>Devices</span>
            </label>
            <label class="scope-label">
              <input type="checkbox" id="scopeNestedGroups">
              <span>Nested groups</span>
            </label>
          </div>
          
          <!-- Typed confirmation for Remove All -->
          <div id="typedConfirmSection" style="display: none;">
            <p class="typed-confirm-instruction">Type <strong>REMOVE ALL</strong> to confirm:</p>
            <input type="text" id="typedConfirmInput" class="typed-confirm-input" placeholder="REMOVE ALL">
          </div>
          
          <div class="modal-actions">
            <button id="confirmRemovalBtn" class="btn-confirm" disabled>
              <i class="material-icons">delete_forever</i>
              Confirm Removal
            </button>
            <button id="cancelRemovalBtn" class="btn-cancel">Cancel</button>
          </div>
        </div>

        <!-- Progress section -->
        <div id="progressSection" style="display: none;">
          <div class="progress-info">
            <p id="progressMessage">Removing members...</p>
            <div class="progress-bar-container">
              <div id="progressBar" class="progress-bar"></div>
            </div>
            <p id="progressDetails" class="progress-details"></p>
          </div>
        </div>

        <!-- Results section -->
        <div id="resultsSection" style="display: none;">
          <div class="results-summary">
            <p id="resultsSummary" class="results-title"></p>
            <div id="resultsDetails" class="results-details"></div>
            <button id="closeResultsBtn" class="btn-close-results">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Add Members Modal Dialog -->
  <div id="bulkAddModal" class="modal-overlay" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-header">
        <h6>Bulk Add Members</h6>
        <button class="modal-close" id="bulkAddModalClose">
          <i class="material-icons">close</i>
        </button>
      </div>
      <div class="modal-body">
        <p id="bulkAddGroupName" class="modal-group-name"></p>

        <!-- Input section -->
        <div id="bulkAddInputSection">
          <p class="modal-description">Paste a list of members to add. Supported formats:</p>
          <ul class="bulk-add-formats-list">
            <li>Device names or IDs, one per line</li>
            <li>User UPNs or IDs, one per line</li>
            <li>Comma, semicolon, or tab delimited values</li>
            <li>JSON array: <code>["value1","value2"]</code></li>
          </ul>
          <textarea id="bulkAddInput" class="bulk-add-textarea" 
                    placeholder="Paste your data here...&#10;&#10;Examples:&#10;device1&#10;device2&#10;&#10;or: user1@domain.com, user2@domain.com&#10;&#10;or: [&quot;value1&quot;,&quot;value2&quot;]" rows="10"></textarea>
          <p id="bulkAddParsedCount" class="bulk-add-parsed-count"></p>

          <div class="modal-actions">
            <button id="confirmBulkAddBtn" class="btn-confirm bulk-add-confirm" disabled>
              <i class="material-icons">group_add</i>
              Add Members
            </button>
            <button id="cancelBulkAddBtn" class="btn-cancel">Cancel</button>
          </div>
        </div>

        <!-- Progress section -->
        <div id="bulkAddProgressSection" style="display: none;">
          <div class="progress-info">
            <p id="bulkAddProgressMessage">Adding members...</p>
            <div class="progress-bar-container">
              <div id="bulkAddProgressBar" class="progress-bar"></div>
            </div>
            <p id="bulkAddProgressDetails" class="progress-details"></p>
          </div>
        </div>

        <!-- Results section -->
        <div id="bulkAddResultsSection" style="display: none;">
          <div class="results-summary">
            <p id="bulkAddResultsSummary" class="results-title"></p>
            <div id="bulkAddResultsDetails" class="results-details"></div>
            <button id="closeBulkAddResultsBtn" class="btn-close-results">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Collect Logs Modal Dialog -->
  <div id="collectLogsModal" class="modal-overlay" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-header">
        <h6>Collect Device Logs</h6>
        <button class="modal-close" id="collectLogsModalClose">
          <i class="material-icons">close</i>
        </button>
      </div>
      <div class="modal-body">
        <p class="modal-description">Configure log collection settings for the device.</p>
        
        <!-- Application ID Input -->
        <div class="collect-logs-section">
          <label class="collect-logs-label">
            <i class="material-icons">app_registration</i>
            Application ID
          </label>
          <input type="text" id="collectLogsAppId" class="collect-logs-input" 
                 placeholder="Enter Intune Win32 application ID">
          <p class="collect-logs-hint">Recommend using a dummy app ID to initialize log collection.</p>
        </div>

        <!-- Predefined Log Paths -->
        <div class="collect-logs-section">
          <label class="collect-logs-label">
            <i class="material-icons">folder_special</i>
            Predefined Log Paths
          </label>
          <div class="collect-logs-checkboxes">
            <label class="collect-logs-checkbox-label">
              <input type="checkbox" id="logPathPSADT" data-path="%WINDIR%\Logs\Software\*.log">
              <span>PSADT - %WINDIR%\Logs\Software\*.log</span>
            </label>
            <label class="collect-logs-checkbox-label">
              <input type="checkbox" id="logPathIME" data-path="%PROGRAMDATA%\Microsoft\IntuneManagementExtension\Logs\*.log" checked>
              <span>IME - %PROGRAMDATA%\Microsoft\IntuneManagementExtension\Logs\*.log</span>
            </label>
          </div>
        </div>

        <!-- Custom Log Paths -->
        <div class="collect-logs-section">
          <label class="collect-logs-label">
            <i class="material-icons">create_new_folder</i>
            Custom Log Paths
          </label>
          <div class="custom-paths-input-group">
            <input type="text" id="customPathInput" class="collect-logs-input" 
                   placeholder="e.g., %TEMP%\MyApp\*.log">
            <button id="addCustomPathBtn" class="btn-add-path">
              <i class="material-icons">add</i>
              Add
            </button>
          </div>
          <p class="collect-logs-hint">
            Supported variables: %PROGRAMFILES%, %PROGRAMDATA%, %PUBLIC%, %WINDIR%, %TEMP%, %TMP%
          </p>
          
          <!-- Custom Paths List -->
          <div id="customPathsList" class="custom-paths-list">
            <!-- Dynamic custom paths will be added here -->
          </div>
        </div>

        <!-- Modal Actions -->
        <div class="modal-actions">
          <button id="confirmCollectLogsBtn" class="btn-confirm">
            <i class="material-icons">bug_report</i>
            Collect Logs
          </button>
          <button id="cancelCollectLogsBtn" class="btn-cancel">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Device Group from Users Modal Dialog -->
  <div id="createDeviceGroupModal" class="modal-overlay" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-header">
        <h6>Create Device Group from Users</h6>
        <button class="modal-close" id="createDeviceGroupModalClose">
          <i class="material-icons">close</i>
        </button>
      </div>
      <div class="modal-body">
        <!-- Input section -->
        <div id="createDeviceGroupInputSection">
          <p id="createDeviceGroupBaseGroupName" class="modal-group-name"></p>
          <p id="createDeviceGroupBaseGroupId" class="modal-group-id"></p>
          <p class="modal-description">
            Creates a new <strong>device</strong> group based on the <strong>primary user</strong> of Intune-managed devices for members of this user group.
          </p>
          
          <!-- New Group Name Input -->
          <div class="create-device-group-section">
            <label class="create-device-group-label">
              <i class="material-icons">group</i>
              New Group Name *
            </label>
            <input type="text" id="newDeviceGroupName" class="create-device-group-input" 
                   placeholder="Enter new device group name" required>
          </div>

          <!-- Device Platform Selection -->
          <div class="create-device-group-section">
            <label class="create-device-group-label">
              <i class="material-icons">devices</i>
              Device Platforms
            </label>
            <div class="create-device-group-checkboxes">
              <label class="create-device-group-checkbox-label">
                <input type="checkbox" id="platformWindows" checked>
                <span>Windows</span>
              </label>
              <label class="create-device-group-checkbox-label">
                <input type="checkbox" id="platformMacOS">
                <span>macOS</span>
              </label>
              <label class="create-device-group-checkbox-label">
                <input type="checkbox" id="platformIOS">
                <span>iOS/iPadOS</span>
              </label>
              <label class="create-device-group-checkbox-label">
                <input type="checkbox" id="platformAndroid">
                <span>Android</span>
              </label>
            </div>
          </div>

          <!-- Include Transitive Members Toggle -->
          <div class="create-device-group-section">
            <label class="create-device-group-label">
              <i class="material-icons">account_tree</i>
              Include Transitive Members
            </label>
            <div class="create-device-group-toggle-container">
              <label class="create-device-group-toggle">
                <input type="checkbox" id="transitiveMembers" checked>
                <span class="create-device-group-toggle-slider"></span>
              </label>
              <span class="create-device-group-toggle-text">Resolve nested group members</span>
            </div>
          </div>

          <!-- Modal Actions -->
          <div class="modal-actions">
            <button id="confirmCreateDeviceGroupBtn" class="btn-confirm">
              <i class="material-icons">devices_other</i>
              Create
            </button>
            <button id="cancelCreateDeviceGroupBtn" class="btn-cancel">Cancel</button>
          </div>
        </div>

        <!-- Progress section -->
        <div id="createDeviceGroupProgressSection" style="display: none;">
          <div class="progress-info">
            <p id="createDeviceGroupProgressMessage">Processing...</p>
            <div class="progress-bar-container">
              <div id="createDeviceGroupProgressBar" class="progress-bar"></div>
            </div>
            <p id="createDeviceGroupProgressDetails" class="progress-details"></p>
          </div>
          <div class="modal-actions">
            <button id="cancelCreateDeviceGroupProcessBtn" class="btn-cancel">Cancel</button>
          </div>
        </div>

        <!-- Confirmation section (for big groups) -->
        <div id="createDeviceGroupConfirmSection" style="display: none;">
          <div class="confirmation-divider"></div>
          
          <p class="confirmation-title">
            <i class="material-icons warning-icon">warning</i>
            Large Device Count Detected
          </p>
          
          <p id="createDeviceGroupConfirmMessage" class="confirmation-message"></p>
          
          <div class="modal-actions">
            <button id="confirmContinueDeviceGroupBtn" class="btn-confirm">
              <i class="material-icons">check_circle</i>
              Continue
            </button>
            <button id="cancelConfirmDeviceGroupBtn" class="btn-cancel">Cancel</button>
          </div>
        </div>

        <!-- Results section -->
        <div id="createDeviceGroupResultsSection" style="display: none;">
          <div class="results-summary">
            <p id="createDeviceGroupResultsSummary" class="results-title"></p>
            <div id="createDeviceGroupResultsDetails" class="results-details"></div>
            <button id="closeCreateDeviceGroupResultsBtn" class="btn-close-results">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/parseJSON.js"></script>
  <script src="js/logMessage.js"></script>
  <script src="js/showNotification.js"></script>
  <script src="js/welcomeContent.js"></script>
  <script src="js/welcomeNotification.js"></script>
  <script src="popup.js"></script>
</body>
</html>